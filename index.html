<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring Dashboard</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- React & ReactDOM -->
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase v9 -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

window.FirebaseApp = initializeApp({
  apiKey: "AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",
  authDomain: "jamia-app-5bd27.firebaseapp.com",
  databaseURL: "https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jamia-app-5bd27",
  storageBucket: "jamia-app-5bd27.appspot.com",
  messagingSenderId: "870308712173",
  appId: "1:870308712173:web:be101df99fef412f7886e4"
});
window.db = getDatabase(window.FirebaseApp);
window.auth = getAuth(window.FirebaseApp);
</script>

<!-- OneSignal -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  await OneSignal.init({ 
    appId: "564eb270-ccb3-428f-b9f8-f162d56321c4",
    allowLocalhostAsSecureOrigin: true
  });
  OneSignal.showSlidedownPrompt(); // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
  window.OneSignal = OneSignal;
});

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ REST App Key Ø§Ù„Ø°ÙŠ Ø²ÙˆØ¯ØªÙ†ÙŠ Ø¨Ù‡
window.sendPush = function(msg){
  fetch('https://onesignal.com/api/v1/notifications',{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':'Basic os_v2_app_kzhle4gmwnbi7opy6frnkyzbyrqitvovpu2ugku5pdtd33igz22ayihzxibmlbr7quywkkczb4hchcca23c5ed2bhsyyikzz7b6k6ui'
    },
    body: JSON.stringify({
      app_id: "564eb270-ccb3-428f-b9f8-f162d56321c4",
      included_segments:["Subscribed Users"],
      headings:{"ar":"ØªÙ†Ø¨ÙŠÙ‡ Spaarkring"},
      contents:{"ar":msg}
    })
  });
}
</script>

</head>
<body class="bg-gray-100 font-sans p-4">

<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;
const members = ["Ù…Ø­Ø³Ù†","Ø³Ù„ÙŠÙ…","Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯","Ù…Ø´ØªØ§Ù‚","Ø±Ø¶ÙˆØ§Ù†","Ø­Ù…Ø²Ø©","Ø¹Ù„ÙŠ","Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†","Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯","Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†"];
const monthKey = new Date().getFullYear() + "-" + String(new Date().getMonth()+1).padStart(2,'0');

function Alert({ message, onClose }) {
  if(!message) return null;
  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded-xl shadow-lg w-80">
        <p className="text-gray-800 text-lg" dangerouslySetInnerHTML={{__html: message}}></p>
        <button onClick={onClose} className="mt-4 w-full bg-blue-600 text-white p-2 rounded font-bold">Ù…ÙˆØ§ÙÙ‚</button>
      </div>
    </div>
  );
}

function MemberTable({ showAlert }) {
  const [payments,setPayments] = useState({});
  useEffect(()=>{
    const paymentsRef = ref(window.db, `payments/${monthKey}`);
    return onValue(paymentsRef, snap=> setPayments(snap.val()||{}));
  },[]);

  const verify=(id,name)=>{
    const code = document.getElementById(`in-${id}`).value;
    const codeRef = ref(window.db, `secret_codes/${id}`);
    onValue(codeRef, snap=>{
      if(String(code)===String(snap.val())){
        set(ref(window.db, `payments/${monthKey}/${id}`), {status:true, date:new Date().toLocaleDateString('ar-EG')});
        showAlert(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº Ù…Ù†: ${name}`);
        window.sendPush(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº Ù…Ù†: ${name}`);
      } else {
        showAlert("âŒ <b>Ø¹Ø°Ø±Ø§Ù‹.. Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£!</b><br>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
      }
    },{onlyOnce:true});
  }

  return (
    <table className="w-full mb-6">
      <thead className="bg-gray-200"><tr><th className="py-2">Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ£ÙƒÙŠØ¯</th></tr></thead>
      <tbody>
        {members.map((name,i)=>{
          const id=i+1;
          const paid=payments[id]?.status;
          return (
            <tr key={id} className="border-b">
              <td className="py-2 font-semibold">{name}</td>
              <td className={paid?"text-green-600":"text-red-600"}>{paid?"âœ…":"âŒ"}</td>
              <td>{paid?"âœ”ï¸":<>
                <input type="number" id={`in-${id}`} className="border px-2 py-1 rounded w-16 text-center"/>
                <button onClick={()=>verify(id,name)} className="bg-green-600 text-white px-2 py-1 rounded ml-2">OK</button>
              </>}</td>
            </tr>
          )
        })}
      </tbody>
    </table>
  )
}

function PayoutTable({ isAdmin }) {
  const [received,setReceived] = useState({});
  useEffect(()=>{
    const rRef = ref(window.db, 'received_totals');
    return onValue(rRef, snap=> setReceived(snap.val()||{}));
  },[]);

  const toggleRec=(id,val)=> set(ref(window.db, `received_totals/${id}`), !val);

  return (
    <div className="bg-green-50 p-4 rounded border border-green-200">
      <h3 className="text-gray-800 font-semibold mb-2">ğŸ’° Ø³Ø¬Ù„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ù„Øº (4000â‚¬)</h3>
      <table className="w-full">
        <thead className="bg-gray-200">
          <tr><th className="py-2">Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>{isAdmin?<th>ØªØ­ÙƒÙ…</th>:null}</tr>
        </thead>
        <tbody>
          {members.map((name,i)=>{
            const id=i+1; const rec=received[id]===true;
            return (
              <tr key={id} className="border-b">
                <td className="py-2">{name}</td>
                <td className={rec?"text-green-600":"text-red-600"}>{rec? "ØªÙ… âœ…":"Ù„Ù… ÙŠØ³ØªÙ„Ù…"}</td>
                {isAdmin && <td><button onClick={()=>toggleRec(id,rec)} className="bg-blue-600 text-white px-2 py-1 rounded text-xs">ØªØ¨Ø¯ÙŠÙ„</button></td>}
              </tr>
            )
          })}
        </tbody>
      </table>
    </div>
  )
}

function AdminPanel({ showAlert }) {
  const [email,setEmail]=useState("");
  const [pass,setPass]=useState("");
  const [isAdmin,setIsAdmin]=useState(false);

  const login=()=>signInWithEmailAndPassword(window.auth,email,pass).then(()=>setIsAdmin(true)).catch(e=>showAlert(e.message));
  const logout=()=>signOut(window.auth).then(()=>setIsAdmin(false));
  const resetMonth=()=>{ if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø±ØŸ")){ remove(ref(window.db, `payments/${monthKey}`)).then(()=>showAlert("ğŸ“… ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ù„Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯")); } }

  return (
    <div className="mt-6 border-t-2 border-dashed border-red-500 pt-4">
      {!isAdmin ? <div>
        <h4 className="text-red-600 mb-2">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h4>
        <input type="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" value={email} onChange={e=>setEmail(e.target.value)} className="border w-full rounded p-2 mb-2"/>
        <input type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value={pass} onChange={e=>setPass(e.target.value)} className="border w-full rounded p-2 mb-2"/>
        <button onClick={login} className="w-full bg-gray-800 text-white rounded p-2 font-bold">Ø¯Ø®ÙˆÙ„</button>
      </div> :
      <div>
        <p className="text-green-600 font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ù…Ø³Ø¤ÙˆÙ„</p>
        <button onClick={resetMonth} className="w-full bg-red-600 text-white rounded p-2 mb-2 font-bold">âš ï¸ ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
        <button onClick={logout} className="w-full bg-gray-500 text-white rounded p-2 font-bold">Ø®Ø±ÙˆØ¬</button>
      </div>}
    </div>
  )
}

function App() {
  const [user,setUser]=useState(null);
  const [alertMsg,setAlertMsg]=useState("");
  const [isAdmin,setIsAdmin]=useState(false);

  useEffect(()=>{
    onAuthStateChanged(window.auth,u=>{
      if(!u) signInAnonymously(window.auth);
      setUser(u);
      setIsAdmin(u && !u.isAnonymous);
    });
  },[]);

  return (
    <div className="max-w-lg mx-auto bg-white p-6 rounded-xl shadow-lg mt-4">
      <h1 className="text-2xl text-blue-600 font-bold cursor-pointer mb-2">Spaarkring</h1>
      <div className="bg-blue-50 p-4 rounded mb-4 font-bold border-r-4 border-blue-600">ğŸ“¢ Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±</div>
      <h3 className="text-gray-700 mb-4">Ø³Ø¬Ù„ Ø´Ù‡Ø±: {new Date().toLocaleDateString('ar-EG',{month:'long',year:'numeric'})}</h3>

      <MemberTable showAlert={setAlertMsg}/>
      <PayoutTable isAdmin={isAdmin}/>
      <AdminPanel showAlert={setAlertMsg}/>

      <Alert message={alertMsg} onClose={()=>setAlertMsg("")}/>
    </div>
  )
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);

</script>

</body>
</html>
