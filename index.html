<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring - Dashboard</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
body { font-family:'Segoe UI', sans-serif; background:#f0f4f8; text-align:center; padding:10px; }
.container { max-width:100%; margin:auto; background:white; padding:20px; border-radius:20px; box-shadow:0 10px 20px rgba(0,0,0,0.1); border-top:8px solid #1a73e8; }
h1 { color:#1a73e8; cursor:pointer; }
.payment-notice { background:#e8f0fe; border:1px solid #1a73e8; padding:15px; border-radius:12px; margin-bottom:20px; font-weight:bold; }
.payout-info { background:#e6ffed; border:2px dashed #34a853; color:#2e7d32; padding:15px; border-radius:12px; margin-top:20px; font-weight:bold; }
table { width:100%; border-collapse:collapse; margin-top:10px; table-layout: fixed; }
th, td { padding:10px 2px; border-bottom:1px solid #eee; text-align:center; font-size:0.9em; }
.paid { color:#28a745; font-weight:bold; }
.not-paid { color:#dc3545; font-weight:bold; }
input { width:50px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:4px; }
button { background:#34a853; color:white; border:none; padding:6px 10px; border-radius:5px; cursor:pointer; }
#adminSection { display:none; margin-top:20px; padding:15px; border:2px solid #dc3545; border-radius:15px; background:#fff5f5; }
.admin-input { width:90%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:5px; }
</style>
</head>
<body>

<div class="container">
    <h1 onclick="showAdminLogin()">Spaarkring</h1>
    <div class="payment-notice">
        ğŸ“¢ Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | ğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±
    </div>

    <h3 id="monthTitle"></h3>
    <table>
        <thead>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªØ£ÙƒÙŠØ¯</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="payout-info">
        ğŸ’° ÙŠØ³ØªÙ„Ù… ÙƒÙ„ Ø¹Ø¶Ùˆ Ù…Ø¨Ù„Øº: 4000 ÙŠÙˆØ±Ùˆ
        <table style="margin-top:10px;">
            <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th></tr></thead>
            <tbody id="payoutTableBody"></tbody>
        </table>
    </div>

    <div id="adminSection">
        <h3 style="color:#dc3545;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
        <input type="email" id="adminEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="admin-input"><br>
        <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="admin-input"><br>
        <button onclick="handleLogin()" style="background:#dc3545; width:90%;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button><br><br>
        <button onclick="resetMonth()" style="background:#666; width:90%;">ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±</button><br><br>
        <button onclick="logout()" style="background:#444; width:90%;">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC-J-Cg9OeZD--fwStoZTFzK4qU4v170M",
    authDomain: "jamia-app-5bd27.firebaseapp.com",
    databaseURL: "https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "jamia-app-5bd27",
    storageBucket: "jamia-app-5bd27.appspot.com",
    messagingSenderId: "870308712173",
    appId: "1:870308712173:web:be101df99fef2085b344a2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const adminUID = "k7l8SxQlgnVjrfDWGnXGprwdSYy1"; // UID Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„

const members = [
    { id:1, name:"Ù…Ø­Ø³Ù†" }, { id:2, name:"Ø³Ù„ÙŠÙ…" }, { id:3, name:"Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯" },
    { id:4, name:"Ù…Ø´ØªØ§Ù‚" }, { id:5, name:"Ø±Ø¶ÙˆØ§Ù†" }, { id:6, name:"Ø­Ù…Ø²Ø©" },
    { id:7, name:"Ø¹Ù„ÙŠ" }, { id:8, name:"Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†" }, { id:9, name:"Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯" },
    { id:10, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†" }
];

const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
document.getElementById("monthTitle").innerText = "Ø³Ø¬Ù„ Ø´Ù‡Ø±: " + new Date().toLocaleDateString('ar-EG',{month:'long', year:'numeric'});

// Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø¬Ù…ÙŠØ¹
auth.onAuthStateChanged(user => {
    if(!user){
        auth.signInAnonymously();
    }
    renderData();
});

function renderData() {
    db.ref().on('value', snapshot => {
        const data = snapshot.val() || {};
        const payments = (data.payments && data.payments[monthKey]) || {};
        const received = data.received_totals || {};
        renderTables(payments, received);
    });
}

function renderTables(payments, received) {
    let html = '';
    members.forEach(m => {
        const p = payments[m.id] || {};
        const isPaid = p.status === true;
        html += `<tr>
            <td><strong>${m.name}</strong></td>
            <td class="${isPaid?'paid':'not-paid'}">${isPaid?'âœ… Ù…Ø¯ÙÙˆØ¹':'âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹'}</td>
            <td>${isPaid?p.date:'-'}</td>
            <td>${isPaid?'âœ”ï¸':`<input type="password" id="c-${m.id}" placeholder="***"><button onclick="verify(${m.id})">OK</button>`}</td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML = html;

    let rHtml = '';
    members.forEach(m=>{
        const hasRec = received[m.id] === true;
        rHtml += `<tr><td>${m.name}</td><td class="${hasRec?'paid':'not-paid'}">${hasRec?'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…':'Ù„Ù… ÙŠØ³ØªÙ„Ù…'}</td></tr>`;
    });
    document.getElementById('payoutTableBody').innerHTML = rHtml;
}

function verify(id){
    const code = document.getElementById('c-'+id).value.trim();
    if(!code){ alert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯"); return; }
    db.ref(`secret_codes/${id}`).once('value').then(snap=>{
        if(String(code)===String(snap.val())){
            db.ref(`payments/${monthKey}/${id}`).set({status:true,date:new Date().toLocaleDateString('ar-EG')})
            .then(()=> alert("âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹"));
        } else { alert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!"); document.getElementById('c-'+id).value=''; }
    });
}

function showAdminLogin(){ document.getElementById('adminSection').style.display='block'; window.scrollTo(0, document.body.scrollHeight); }

function handleLogin(){
    const email=document.getElementById('adminEmail').value;
    const pass=document.getElementById('adminPass').value;
    auth.signInWithEmailAndPassword(email, pass)
        .then(()=> alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„"))
        .catch(err=> alert("âŒ "+err.message));
}

function logout(){ auth.signOut().then(()=> location.reload()); }

function resetMonth(){
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ")){
        db.ref(`payments/${monthKey}`).remove().then(()=> alert("âœ… ØªÙ… ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±."));
    }
}
</script>

</body>
</html>
