<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring - Fixed</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
    body { font-family:'Segoe UI', sans-serif; background:#f0f4f8; padding:10px; text-align:center; direction: rtl; }
    .container { max-width:100%; margin:auto; background:white; padding:20px; border-radius:20px; box-shadow:0 10px 20px rgba(0,0,0,0.1); border-top:8px solid #1a73e8; }
    h1 { color:#1a73e8; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:10px 5px; border-bottom:1px solid #eee; text-align:center; font-size:0.9em; }
    .paid { color:#28a745; font-weight:bold; }
    .not-paid { color:#dc3545; font-weight:bold; }
    #adminSection { display:none; margin-top:30px; padding:20px; border:2px solid #dc3545; border-radius:15px; background:#fff5f5; }
    .admin-input { width:90%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:5px; }
    input[type="password"] { width:50px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:4px; }
    button { background:#34a853; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
</style>
</head>
<body>

<div class="container">
    <h1 onclick="adminLoginPrompt()">Spaarkring</h1>
    <div style="background:#e8f0fe; padding:15px; border-radius:12px; margin-bottom:20px;">
        ğŸ“¢ Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | ğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±
    </div>

    <h3 id="monthTitle"></h3>
    <table>
        <thead>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªØ£ÙƒÙŠØ¯</th></tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...</td></tr>
        </tbody>
    </table>

    <h2 style="margin-top:40px;">Ø³Ø¬Ù„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h2>
    <table>
        <thead>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th><th class="admin-only" style="display:none;">ØªØ­ÙƒÙ…</th></tr>
        </thead>
        <tbody id="payoutTableBody"></tbody>
    </table>

    <div id="adminSection">
        <h3 style="color:#dc3545;">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
        <input type="email" id="adminEmail" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" class="admin-input"><br>
        <input type="password" id="adminPass" placeholder="Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯" class="admin-input"><br>
        <button onclick="handleLogin()" style="background:#dc3545; width:90%; padding:10px;">Ø¯Ø®ÙˆÙ„</button>
        <hr>
        <button onclick="resetMonth()" style="background:#666; width:90%; padding:8px; margin-top:10px;">ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø±</button>
        <button onclick="logout()" style="background:#444; width:90%; padding:8px; margin-top:10px;">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
// Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…ÙØ¹Ù„ Ù…Ù† ØµÙˆØ±Ùƒ
const firebaseConfig = {
  apiKey: "AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",
  authDomain: "jamia-app-5bd27.firebaseapp.com",
  databaseURL: "https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jamia-app-5bd27",
  storageBucket: "jamia-app-5bd27.appspot.com",
  messagingSenderId: "870308712173",
  appId: "1:870308712173:web:be101df99fef412f7886e4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const members = [
    { id:1, name:"Ù…Ø­Ø³Ù†" }, { id:2, name:"Ø³Ù„ÙŠÙ…" }, { id:3, name:"Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯" },
    { id:4, name:"Ù…Ø´ØªØ§Ù‚" }, { id:5, name:"Ø±Ø¶ÙˆØ§Ù†" }, { id:6, name:"Ø­Ù…Ø²Ø©" },
    { id:7, name:"Ø¹Ù„ÙŠ" }, { id:8, name:"Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†" }, { id:9, name:"Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯" },
    { id:10, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†" }
];

const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
document.getElementById("monthTitle").innerText = "Ø³Ø¬Ù„ Ø´Ù‡Ø±: " + new Date().toLocaleDateString('ar-EG',{month:'long', year:'numeric'});

// Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
auth.onAuthStateChanged(user => {
    if (user && !user.isAnonymous) {
        document.getElementById('adminSection').style.display = 'block';
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'table-cell');
    } else if (!user) {
        auth.signInAnonymously();
    }
    fetchData(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª
});

function fetchData() {
    db.ref().on('value', snapshot => {
        const data = snapshot.val() || {};
        const payments = data.payments ? (data.payments[monthKey] || {}) : {};
        const received = data.received_totals || {};
        renderTables(payments, received);
    }, error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        alert("ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ (Rules) ÙÙŠ Firebase");
    });
}

function renderTables(payments, received) {
    let html = '';
    members.forEach(m => {
        const p = payments[m.id] || {};
        const isPaid = p.status === true;
        html += `<tr>
            <td><strong>${m.name}</strong></td>
            <td class="${isPaid?'paid':'not-paid'}">${isPaid?'âœ…':'âŒ'}</td>
            <td>${isPaid ? p.date : '-'}</td>
            <td>${isPaid?'âœ”ï¸':`<input type="password" id="c-${m.id}" placeholder="***"><button onclick="verify(${m.id})">OK</button>`}</td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML = html;

    let rHtml = '';
    const isAdmin = auth.currentUser && !auth.currentUser.isAnonymous;
    members.forEach(m => {
        const hasRec = received[m.id] === true;
        rHtml += `<tr>
            <td>${m.name}</td>
            <td><span class="${hasRec?'paid':'not-paid'}">${hasRec?'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…':'Ù„Ù… ÙŠØ³ØªÙ„Ù…'}</span></td>
            ${isAdmin ? `<td class="admin-only"><button onclick="toggleRec(${m.id}, ${hasRec})">ØªØ¹Ø¯ÙŠÙ„</button></td>` : ''}
        </tr>`;
    });
    document.getElementById('payoutTableBody').innerHTML = rHtml;
}

function verify(id) {
    const code = document.getElementById('c-' + id).value;
    db.ref('secret_codes/' + id).once('value', snap => {
        if(String(code) === String(snap.val())) {
            db.ref(`payments/${monthKey}/${id}`).set({ status:true, date:new Date().toLocaleDateString('ar-EG') });
            alert("ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­");
        } else { alert("Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£!"); }
    });
}

function handleLogin() {
    const email = document.getElementById('adminEmail').value;
    const pass = document.getElementById('adminPass').value;
    auth.signInWithEmailAndPassword(email, pass).catch(err => alert("Ø®Ø·Ø£: " + err.message));
}

function logout() { auth.signOut().then(() => location.reload()); }
function toggleRec(id, status) { db.ref(`received_totals/${id}`).set(!status); }
function resetMonth() { if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø±ØŸ")) db.ref(`payments/${monthKey}`).remove(); }
function adminLoginPrompt() { document.getElementById('adminSection').style.display = 'block'; window.scrollTo(0, document.body.scrollHeight); }
</script>
</body>
</html>
