<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring Admin</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; text-align: center; direction: rtl; }
    .container { max-width: 500px; margin: 20px auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    h1 { color: #2c3e50; cursor: pointer; }
    .status-card { background: #e8f4fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; border-left: 5px solid #3498db; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 5px; border-bottom: 1px solid #eee; font-size: 0.9em; }
    .paid { color: #27ae60; font-weight: bold; }
    .not-paid { color: #e74c3c; font-weight: bold; }
    .btn-verify { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    #adminSection { display: none; margin-top: 30px; border-top: 2px dashed #e74c3c; padding-top: 20px; }
    .admin-input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
    .btn-reset { background: #c0392b; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .btn-edit { background: #2980b9; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 0.8em; margin-right: 5px; }
</style>
</head>
<body>

<div class="container">
    <h1 onclick="toggleAdmin()">Spaarkring</h1>
    <div class="status-card">
        Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±
    </div>
    
    <h3 id="currentMonthDisplay"></h3>
    
    <table>
        <thead>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ£ÙƒÙŠØ¯</th></tr>
        </thead>
        <tbody id="memberTable"></tbody>
    </table>

    <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-top:30px; border:1px solid #ddd;">
        <h3 style="margin-top:0;">ğŸ’° Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (4000â‚¬)</h3>
        <table>
            <tbody id="payoutTable"></tbody>
        </table>
    </div>

    <div id="adminSection">
        <h3 style="color:#c0392b;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
        <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="admin-input">
        <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="admin-input">
        <button onclick="login()" style="background:#2c3e50; color:white; width:95%; padding:10px; border:none; border-radius:5px; margin-bottom:15px;">Ø¯Ø®ÙˆÙ„</button>
        <hr>
        <button onclick="resetMonthData()" class="btn-reset">âš ï¸ ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
        <p style="font-size: 0.8em; color: #7f8c8d;">(Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·)</p>
        <button onclick="logout()" style="background:#95a5a6; color:white; border:none; padding:8px; border-radius:5px; margin-top:10px; width:95%;">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",
    authDomain: "jamia-app-5bd27.firebaseapp.com",
    databaseURL: "https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "jamia-app-5bd27",
    storageBucket: "jamia-app-5bd27.appspot.com",
    messagingSenderId: "870308712173",
    appId: "1:870308712173:web:be101df99fef412f7886e4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const members = ["Ù…Ø­Ø³Ù†", "Ø³Ù„ÙŠÙ…", "Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯", "Ù…Ø´ØªØ§Ù‚", "Ø±Ø¶ÙˆØ§Ù†", "Ø­Ù…Ø²Ø©", "Ø¹Ù„ÙŠ", "Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†", "Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯", "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†"];
const monthKey = new Date().getFullYear() + "-" + (new Date().getMonth() + 1).toString().padStart(2, '0');

document.getElementById('currentMonthDisplay').innerText = "Ø³Ø¬Ù„ Ø´Ù‡Ø±: " + new Date().toLocaleDateString('ar-EG', {month:'long', year:'numeric'});

auth.onAuthStateChanged(user => {
    if(!user) auth.signInAnonymously();
    if(user && !user.isAnonymous) document.getElementById('adminSection').style.display = 'block';
    loadData();
});

function loadData() {
    db.ref().on('value', snap => {
        const data = snap.val() || {};
        const payments = data.payments ? (data.payments[monthKey] || {}) : {};
        const received = data.received_totals || {};
        
        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹
        let h = '';
        members.forEach((name, i) => {
            const id = i + 1;
            const paid = payments[id] && payments[id].status;
            h += `<tr>
                <td><b>${name}</b></td>
                <td class="${paid?'paid':'not-paid'}">${paid?'âœ… Ù…Ø¯ÙÙˆØ¹':'âŒ'}</td>
                <td>${paid?'âœ”ï¸':`<input type="password" id="in-${id}" style="width:40px; text-align:center;"> <button onclick="verify(${id})" class="btn-verify">OK</button>`}</td>
            </tr>`;
        });
        document.getElementById('memberTable').innerHTML = h;

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
        let ph = '';
        const isAdmin = auth.currentUser && !auth.currentUser.isAnonymous;
        members.forEach((name, i) => {
            const id = i + 1;
            const rec = received[id] === true;
            ph += `<tr>
                <td>${name}</td>
                <td class="${rec?'paid':'not-paid'}">${rec?'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…':'Ù„Ù… ÙŠØ³ØªÙ„Ù…'}</td>
                ${isAdmin ? `<td><button class="btn-edit" onclick="toggleRec(${id},${rec})">ØªØ¨Ø¯ÙŠÙ„</button></td>` : ''}
            </tr>`;
        });
        document.getElementById('payoutTable').innerHTML = ph;
    });
}

function verify(id) {
    const code = document.getElementById('in-'+id).value;
    db.ref('secret_codes/'+id).once('value', s => {
        if(String(code) === String(s.val())) {
            db.ref(`payments/${monthKey}/${id}`).set({status: true, date: new Date().toLocaleDateString('ar-EG')});
        } else { alert("Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£!"); }
    });
}

function resetMonthData() {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø¯ÙØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ")) {
        db.ref(`payments/${monthKey}`).remove()
            .then(() => alert("âœ… ØªÙ… Ø§Ù„ØªØµÙÙŠØ± Ø¨Ù†Ø¬Ø§Ø­ Ù„Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯"))
            .catch(e => alert("Ø®Ø·Ø£: " + e.message));
    }
}

function toggleRec(id, s) { db.ref(`received_totals/${id}`).set(!s); }
function toggleAdmin() { document.getElementById('adminSection').style.display = 'block'; window.scrollTo(0,document.body.scrollHeight); }
function login() { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value).catch(e => alert(e.message)); }
function logout() { auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
