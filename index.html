<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring - Secure</title>

<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({ appId: "564eb270-ccb3-428f-b9f8-f162d56321c4" });
  });
</script>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
    body { font-family: 'Segoe UI', sans-serif; background:#f0f4f8; padding:10px; text-align:center; }
    .container { max-width:100%; margin:auto; background:white; padding:20px; border-radius:20px; box-shadow:0 10px 20px rgba(0,0,0,0.1); border-top:8px solid #1a73e8; margin-bottom:20px; }
    h1 { color:#1a73e8; margin-bottom:15px; }
    .payment-notice { background:#e8f0fe; border:1px solid #1a73e8; padding:15px; border-radius:12px; margin-bottom:20px; font-weight:bold; }
    .payout-info { background-color:#e6ffed; border:2px dashed #34a853; color:#2e7d32; padding:15px; border-radius:12px; margin-top:20px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; table-layout: fixed; }
    th,td { padding:10px 2px; border-bottom:1px solid #eee; text-align:center; font-size: 0.85em; }
    .paid { color:#28a745; font-weight:bold; }
    .not-paid { color:#dc3545; font-weight:bold; }
    .received-btn { background:#1a73e8; color:white; border:none; padding:5px; border-radius:5px; cursor:pointer; font-size:0.8em; }
    #adminSection { display:none; margin-top:30px; padding:20px; border:2px solid #dc3545; border-radius:15px; background:#fff5f5; }
    .login-trigger { margin-top:50px; color:#ddd; font-size:0.7em; cursor:pointer; }
    input { width:50px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:4px; }
    .admin-input { width: 85%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:5px; }
</style>
</head>

<body>

<div class="container">
    <h1 onclick="adminLoginPrompt()">Spaarkring</h1>
    <div class="payment-notice">
        ğŸ“¢ Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | ğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±
    </div>

    <h3 id="monthTitle"></h3>
    <table>
        <thead>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªØ£ÙƒÙŠØ¯</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="payout-info">
        <span style="font-weight:bold; font-size:1.2em;">ğŸ’° ÙŠØ³ØªÙ„Ù… ÙƒÙ„ Ø¹Ø¶Ùˆ Ù…Ø¨Ù„Øº: 4000 ÙŠÙˆØ±Ùˆ</span>
        <table style="margin-top:15px;">
            <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th><th id="adminHeader" style="display:none;">ØªØ­ÙƒÙ…</th></tr></thead>
            <tbody id="payoutTableBody"></tbody>
        </table>
    </div>

    <div id="adminSection">
        <h3 style="color:#dc3545;">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
        <input type="email" id="adminEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="admin-input"><br>
        <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="admin-input"><br>
        <button onclick="handleLogin()" style="background:#dc3545; width:85%; padding:10px; color:white; border:none; border-radius:5px; cursor:pointer;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
        <button onclick="logout()" style="margin-top:10px; background:#666; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Ø®Ø±ÙˆØ¬</button>
    </div>
    <div class="login-trigger" onclick="adminLoginPrompt()">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</div>
</div>

<script>
// Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ ÙŠØ§ Ù…Ø­Ù…Ø¯
const firebaseConfig = {
  apiKey: "AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",
  authDomain: "jamia-app-5bd27.firebaseapp.com",
  databaseURL: "https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jamia-app-5bd27",
  storageBucket: "jamia-app-5bd27.firebasestorage.app",
  messagingSenderId: "870308712173",
  appId: "1:870308712173:web:be101df99fef412f7886e4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const members = [
    { id:1, name:"Ù…Ø­Ø³Ù†" }, { id:2, name:"Ø³Ù„ÙŠÙ…" }, { id:3, name:"Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯" },
    { id:4, name:"Ù…Ø´ØªØ§Ù‚" }, { id:5, name:"Ø±Ø¶ÙˆØ§Ù†" }, { id:6, name:"Ø­Ù…Ø²Ø©" },
    { id:7, name:"Ø¹Ù„ÙŠ" }, { id:8, name:"Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†" }, { id:9, name:"Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯" },
    { id:10, name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†" }
];

const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
document.getElementById("monthTitle").innerText = "Ø³Ø¬Ù„ Ø´Ù‡Ø±: " + new Date().toLocaleDateString('ar-EG',{month:'long', year:'numeric'});

// Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©
auth.onAuthStateChanged(user => {
    if (user && !user.isAnonymous) {
        document.getElementById('adminSection').style.display = 'block';
        document.getElementById('adminHeader').style.display = 'table-cell';
    } else if (!user) {
        auth.signInAnonymously();
    }
});

function handleLogin() {
    const email = document.getElementById('adminEmail').value;
    const pass = document.getElementById('adminPass').value;
    auth.signInWithEmailAndPassword(email, pass)
        .then(() => { alert("Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…Ø­Ù…Ø¯"); })
        .catch(err => alert("Ø®Ø·Ø£: " + err.message));
}

function logout() { auth.signOut().then(() => location.reload()); }

db.ref().on('value', snapshot => {
    const data = snapshot.val() || {};
    const payments = data.payments ? (data.payments[monthKey] || {}) : {};
    const received = data.received_totals || {};

    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
    let html = '';
    members.forEach(m => {
        const p = payments[m.id] || {};
        const isPaid = p.status === true;
        html += `<tr>
            <td><strong>${m.name}</strong></td>
            <td class="${isPaid?'paid':'not-paid'}">${isPaid?'âœ…':'âŒ'}</td>
            <td>${isPaid ? p.date : '-'}</td>
            <td>${isPaid?'âœ”ï¸':`<input type="password" id="c-${m.id}" placeholder="***"><button onclick="verify(${m.id})">OK</button>`}</td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML = html;

    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…
    let rHtml = '';
    const isAdmin = auth.currentUser && !auth.currentUser.isAnonymous;
    members.forEach(m => {
        const hasRec = received[m.id] === true;
        rHtml += `<tr>
            <td>${m.name}</td>
            <td><span class="${hasRec?'paid':'not-paid'}">${hasRec?'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…':'Ù„Ù… ÙŠØ³ØªÙ„Ù…'}</span></td>
            ${isAdmin ? `<td><button class="received-btn" onclick="toggleReceived(${m.id}, ${hasRec})">ØªØ¨Ø¯ÙŠÙ„</button></td>` : ''}
        </tr>`;
    });
    document.getElementById('payoutTableBody').innerHTML = rHtml;
});

function verify(id) {
    const code = document.getElementById('c-' + id).value;
    if(!code) return;
    db.ref('secret_codes/' + id).once('value', snap => {
        if(String(code) === String(snap.val())) {
            db.ref(`payments/${monthKey}/${id}`).set({ status:true, date:new Date().toLocaleDateString('ar-EG') });
        } else { alert("Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­"); }
    });
}

function toggleReceived(id, currentStatus) {
    db.ref(`received_totals/${id}`).set(!currentStatus);
}

function adminLoginPrompt() {
    document.getElementById('adminSection').style.display = 'block';
    window.scrollTo(0, document.body.scrollHeight);
}
</script>
</body>
</html>
