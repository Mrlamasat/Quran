<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring - Dashboard</title>

<!-- OneSignal SDK -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function(OneSignal) {
  await OneSignal.init({
    appId: "564eb270-ccb3-428f-b9f8-f162d56321c4",
    notifyButton: { enable: true },
    allowLocalhostAsSecureOrigin: true
  });
});
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
body { font-family:'Segoe UI', Tahoma, sans-serif; background:#f4f7f6; text-align:center; direction:rtl; margin:0; padding:10px; }
.container { max-width:500px; margin:10px auto; background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1); }
h1 { color:#1a73e8; cursor:pointer; margin-bottom:5px; }
.status-card { background:#e8f4fd; padding:15px; border-radius:10px; margin-bottom:20px; font-weight:bold; border-right:5px solid #1a73e8; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th, td { padding:10px 5px; border-bottom:1px solid #eee; font-size:0.85em; }
.paid { color:#27ae60; font-weight:bold; }
.not-paid { color:#e74c3c; font-weight:bold; }
.code-input { width:50px; padding:8px; text-align:center; border:1px solid #ccc; border-radius:5px; font-weight:bold; }
.btn-verify { background:#27ae60; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-weight:bold; }
.payout-container { background:#f9fffb; padding:15px; border-radius:10px; margin-top:30px; border:1px solid #d1fae5; }
.custom-alert { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); }
.alert-content { background:white; margin:30% auto; padding:25px; border-radius:15px; width:80%; max-width:350px; }
.alert-btn { background:#1a73e8; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; width:100%; margin-top:15px; font-weight:bold; }
#adminPanel { display:none; margin-top:30px; border-top:2px dashed #dc3545; padding:15px; background:#fffdfd; border-radius:10px; }
.admin-input { width:90%; padding:12px; margin:5px 0; border:1px solid #ddd; border-radius:8px; }
.btn-reset { background:#c0392b; color:white; border:none; padding:12px; width:100%; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:15px; }
</style>
</head>
<body>

<div class="container">
  <h1 onclick="toggleAdminView()">Spaarkring</h1>
  <div class="status-card">ğŸ“¢ Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±</div>
  <h3 id="monthLabel"></h3>

  <table>
    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th></th></tr></thead>
    <tbody id="memberTable"></tbody>
  </table>

  <div class="payout-container">
    <h3>ğŸ’° Ø³Ø¬Ù„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h3>
    <table>
      <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th></th></tr></thead>
      <tbody id="payoutTable"></tbody>
    </table>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù -->
  <div id="adminPanel">
    <div id="loginForm">
      <h4 style="color:#c0392b;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h4>
      <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" class="admin-input" autocomplete="off">
      <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="admin-input" autocomplete="new-password">
      <button onclick="loginAdmin()" class="btn-reset">Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div id="adminControls" style="display:none;">
      <p style="color:#27ae60; font-weight:bold;">Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ Ù…Ø­Ù…Ø¯</p>
      <button onclick="resetMonthData()" class="btn-reset">âš ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø±</button>
      <button onclick="logoutAdmin()" style="background:#95a5a6;">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</div>

<div id="myAlert" class="custom-alert">
  <div class="alert-content">
    <p id="alertMsg"></p>
    <button onclick="closeAlert()" class="alert-btn">Ù…ÙˆØ§ÙÙ‚</button>
  </div>
</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey:"AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",
  authDomain:"jamia-app-5bd27.firebaseapp.com",
  databaseURL:"https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"jamia-app-5bd27",
  storageBucket:"jamia-app-5bd27.appspot.com",
  messagingSenderId:"870308712173",
  appId:"1:870308712173:web:be101df99fef412f7886e4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// ØªØ¨Ø¯ÙŠÙ„ Ø£Ù…Ø§ÙƒÙ† Ø­Ù…Ø²Ø© ÙˆØ¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†
const members=["Ù…Ø­Ø³Ù†","Ø³Ù„ÙŠÙ…","Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯","Ù…Ø´ØªØ§Ù‚","Ø±Ø¶ÙˆØ§Ù†","Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†","Ø¹Ù„ÙŠ","Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†","Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯","Ø­Ù…Ø²Ø©"];
const monthKey = new Date().getFullYear() + "-" + (new Date().getMonth()+1).toString().padStart(2,'0');
document.getElementById('monthLabel').innerText = "Ø³Ø¬Ù„ Ø´Ù‡Ø±: " + new Date().toLocaleDateString('ar-EG',{month:'long', year:'numeric'});

function showAlert(msg){ document.getElementById('alertMsg').innerText=msg; document.getElementById('myAlert').style.display='block'; }
function closeAlert(){ document.getElementById('myAlert').style.display='none'; }

auth.onAuthStateChanged(user=>{
  document.getElementById('adminPanel').style.display = 'block';
  if(!user) { auth.signInAnonymously(); loadData(false); return; }
  const isAdmin = !user.isAnonymous && user.email.toLowerCase() === "mohammeddalmohsen@gmail.com";
  showAdmin(isAdmin);
  loadData(isAdmin);
});

function showAdmin(isAdmin){
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('adminControls').style.display = isAdmin?'block':'none';
}

function toggleAdminView(){
  const f = document.getElementById('loginForm');
  f.style.display = (f.style.display==='block')?'none':'block';
}

// Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
function loadData(isAdmin){
  db.ref().on('value', snap=>{
    const data = snap.val() || {};
    const payments = (data.payments && data.payments[monthKey]) ? data.payments[monthKey] : {};
    const received = data.received_totals || {};

    // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹
    let h='';
    members.forEach((name,i)=>{
      const id=i+1;
      const paid = payments[id] && payments[id].status;
      h+=`<tr>
        <td><b>${name}</b></td>
        <td class="${paid?'paid':'not-paid'}">${paid?'âœ…':'âŒ'}</td>
        <td>${paid?'âœ”ï¸':`<input type="number" id="in-${id}" class="code-input" inputmode="numeric"> <button onclick="verify(${id},'${name}')" class="btn-verify">OK</button>`}</td>
      </tr>`;
    });
    document.getElementById('memberTable').innerHTML=h;

    // Ø¬Ø¯ÙˆÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…Ø¹ Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø²Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
    let ph='';
    members.forEach((name,i)=>{
      const id=i+1;
      const rec = received[id]===true;
      ph+=`<tr>
        <td>${name}</td>
        <td class="${rec?'paid':'not-paid'}">${rec?name+' Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© âœ…':'Ù„Ù… ÙŠØ³ØªÙ„Ù…'}</td>
        <td>${isAdmin?`<button onclick="toggleRec(${id},${rec})" class="btn-verify">ØªØ¨Ø¯ÙŠÙ„</button>`:''}</td>
      </tr>`;
    });
    document.getElementById('payoutTable').innerHTML=ph;
  });
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±
function verify(id,name){
  const val = document.getElementById('in-'+id).value;
  if(!val) return showAlert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯");
  db.ref('secret_codes/'+id).once('value').then(snap=>{
    if(String(val)===String(snap.val())){
      db.ref(`payments/${monthKey}/${id}`).set({status:true,date:new Date().toLocaleDateString()});
      showAlert(`âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù€ ${name}`);
      sendPushNotification(`${name} Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
    }else{ showAlert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­"); }
  });
}

async function sendPushNotification(msg){
  try{
    await fetch('/api/send-notification',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ message:msg })
    });
    console.log("Notification sent:", msg);
  }catch(e){ console.error("Notification Error:", e); }
}

function resetMonthData(){
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ")){
    db.ref('payments/'+monthKey).remove().then(()=>{
      showAlert("ğŸ“… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­");
      sendPushNotification("ğŸ“… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­");
    });
  }
}

function toggleRec(id,s){ 
  db.ref('received_totals/'+id).set(!s); 
  const name = document.querySelector(`#payoutTable tr:nth-child(${id}) td:first-child`).innerText;
  if(!s) sendPushNotification(`${name} Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
}
function loginAdmin(){ 
  const e=document.getElementById('email').value; 
  const p=document.getElementById('pass').value; 
  auth.signInWithEmailAndPassword(e,p).catch(err=>showAlert("Ø®Ø·Ø£: "+err.message)); 
}
function logoutAdmin(){ auth.signOut().then(()=>location.reload()); }
</script>
</body>
</html>
