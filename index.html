<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring - Admin & Member</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
body { font-family:'Segoe UI', sans-serif; background:#f0f4f8; padding:10px; text-align:center; }
.container { max-width:100%; margin:auto; background:white; padding:20px; border-radius:20px; box-shadow:0 10px 20px rgba(0,0,0,0.1); border-top:8px solid #1a73e8; margin-bottom:20px; }
h1 { color:#1a73e8; margin-bottom:15px; cursor:pointer; }
.payment-notice { background:#e8f0fe; border:1px solid #1a73e8; padding:15px; border-radius:12px; margin-bottom:20px; font-weight:bold; }
.payout-info { background:#e6ffed; border:2px dashed #34a853; color:#2e7d32; padding:15px; border-radius:12px; margin-top:20px; font-weight:bold; }
table { width:100%; border-collapse:collapse; margin-top:10px; table-layout:fixed; }
th,td { padding:10px 5px; border-bottom:1px solid #eee; text-align:center; font-size:0.9em; }
th { background:#f8f9fa; color:#555; }
.paid { color:#28a745; font-weight:bold; background:#e6ffed; padding:5px 8px; border-radius:5px; }
.not-paid { color:#dc3545; font-weight:bold; background:#ffeef0; padding:5px 8px; border-radius:5px; }
input { width:50px; padding:5px; text-align:center; border:1px solid #ddd; border-radius:4px; }
button { background:#34a853; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; }
#customAlert { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:25px; border-radius:15px; box-shadow:0 0 30px rgba(0,0,0,0.3); z-index:1000; width:85%; max-width:320px; }
#overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; }
.close-btn { background:#1a73e8; color:white; border:none; padding:8px 20px; border-radius:5px; margin-top:15px; cursor:pointer; width:100%; }
#adminSection { display:none; margin-top:30px; padding:20px; border:2px solid #dc3545; border-radius:15px; background:#fff5f5; }
.admin-input { width:90%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:5px; }
.admin-btn { background:#1a73e8; color:white; border:none; padding:4px 8px; border-radius:5px; cursor:pointer; font-size:0.8em; }
.admin-only { display:none; }
@media screen and (max-width:600px){ th,td{ font-size:0.8em; padding:6px 2px; } .container{ padding:10px; } h1{ font-size:1.6em; } }
</style>
</head>
<body>

<div id="overlay"></div>
<div id="customAlert">
  <p id="alertMessage" style="font-weight:bold;font-size:1.1em;"></p>
  <button class="close-btn" onclick="closeAlert()">Ù…ÙˆØ§ÙÙ‚</button>
</div>

<div class="container">
    <h1 onclick="adminLoginPrompt()">Spaarkring</h1>
    <div class="payment-notice">
        ğŸ“¢ Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | ğŸ“… Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±
    </div>

    <h3 id="monthTitle"></h3>

    <table>
        <thead>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>ØªØ£ÙƒÙŠØ¯</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <hr style="margin:30px 0; border:0; border-top:1px solid #eee;">

    <h2>Ø³Ø¬Ù„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h2>
    <table>
        <thead>
            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th><th class="admin-only">ØªØ­ÙƒÙ…</th></tr>
        </thead>
        <tbody id="payoutTableBody"></tbody>
    </table>

    <div class="payout-info">
        ğŸ’° ÙŠØ³ØªÙ„Ù… ÙƒÙ„ Ø¹Ø¶Ùˆ Ù…Ø¨Ù„Øº: 4000 ÙŠÙˆØ±Ùˆ
    </div>

    <div id="adminSection">
        <h3 style="color:#dc3545;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„)</h3>
        <input type="email" id="adminEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" class="admin-input"><br>
        <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="admin-input"><br>
        <button onclick="handleLogin()" style="background:#dc3545;width:90%;padding:10px;color:white;border:none;border-radius:5px;cursor:pointer;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</button>
        <hr>
        <button onclick="resetMonth()" style="background:#666;color:white;border:none;padding:8px;border-radius:5px;width:90%;margin-bottom:10px;">ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
        <button onclick="logout()" style="background:#444;color:white;border:none;padding:8px;border-radius:5px;width:90%;">Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",
  authDomain: "jamia-app-5bd27.firebaseapp.com",
  databaseURL: "https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "jamia-app-5bd27",
  storageBucket: "jamia-app-5bd27.appspot.com",
  messagingSenderId: "870308712173",
  appId: "1:870308712173:web:be101df99fef412f7886e4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

const members = [
    { id:1,name:"Ù…Ø­Ø³Ù†"},{ id:2,name:"Ø³Ù„ÙŠÙ…"},{ id:3,name:"Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯"},
    { id:4,name:"Ù…Ø´ØªØ§Ù‚"},{ id:5,name:"Ø±Ø¶ÙˆØ§Ù†"},{ id:6,name:"Ø­Ù…Ø²Ø©"},
    { id:7,name:"Ø¹Ù„ÙŠ"},{ id:8,name:"Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†"},{ id:9,name:"Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯"},
    { id:10,name:"Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†"}
];

const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
document.getElementById("monthTitle").innerText = "Ø³Ø¬Ù„ Ø´Ù‡Ø±: " + new Date().toLocaleDateString('ar-EG',{month:'long',year:'numeric'});

// Ù†ÙˆØ§ÙØ° Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
function showAlert(msg){
    document.getElementById('alertMessage').innerText = msg;
    document.getElementById('customAlert').style.display='block';
    document.getElementById('overlay').style.display='block';
}
function closeAlert(){
    document.getElementById('customAlert').style.display='none';
    document.getElementById('overlay').style.display='none';
}

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ Ø£Ùˆ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
auth.onAuthStateChanged(user=>{
    if(user && !user.isAnonymous){
        document.getElementById('adminSection').style.display='block';
        document.querySelectorAll('.admin-only').forEach(el=>el.style.display='table-cell');
        fetchData();
    } else {
        auth.signInAnonymously().then(()=>fetchData());
    }
});

// ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
function handleLogin(){
    const email=document.getElementById('adminEmail').value;
    const pass=document.getElementById('adminPass').value;
    auth.signInWithEmailAndPassword(email,pass).catch(err=>showAlert("Ø®Ø·Ø£: "+err.message));
}
function logout(){ auth.signOut().then(()=>location.reload()); }

// Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function fetchData(){
    db.ref().on('value', snapshot=>{
        const data = snapshot.val()||{};
        const payments = data.payments ? (data.payments[monthKey]||{}) : {};
        const received = data.received_totals || {};
        renderTables(payments,received);
        checkLatePayments(payments);
    });
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
function renderTables(payments,received){
    let html='';
    members.forEach(m=>{
        const p = payments[m.id]||{};
        const isPaid = p.status===true;
        html+=`<tr>
            <td><strong>${m.name}</strong></td>
            <td class="${isPaid?'paid':'not-paid'}">${isPaid?'âœ…':'âŒ'}</td>
            <td>${isPaid?p.date:'-'}</td>
            <td>${isPaid?'âœ”ï¸':`<input type="password" id="c-${m.id}" placeholder="***"><button onclick="verify(${m.id})">OK</button>`}</td>
        </tr>`;
    });
    document.getElementById('tableBody').innerHTML=html;

    let rHtml='';
    const isAdmin = auth.currentUser && !auth.currentUser.isAnonymous;
    members.forEach(m=>{
        const hasRec = received[m.id]===true;
        rHtml+=`<tr>
            <td>${m.name}</td>
            <td><span class="${hasRec?'paid':'not-paid'}">${hasRec?'ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… âœ…':'Ù„Ù… ÙŠØ³ØªÙ„Ù…'}</span></td>
            ${isAdmin?`<td class="admin-only"><button class="admin-btn" onclick="toggleRec(${m.id},${hasRec})">ØªØ¹Ø¯ÙŠÙ„</button></td>`:''}
        </tr>`;
    });
    document.getElementById('payoutTableBody').innerHTML=rHtml;
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ Ù„ÙƒÙ„ Ø¹Ø¶Ùˆ
function verify(id){
    const code=document.getElementById('c-'+id).value;
    if(!code){ showAlert("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯"); return; }
    db.ref('secret_codes/'+id).once('value',snap=>{
        if(String(code)===String(snap.val())){
            const dateStr=new Date().toLocaleDateString('ar-EG');
            db.ref(`payments/${monthKey}/${id}`).set({status:true,date:dateStr});
            showAlert("âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹");
        } else {
            showAlert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­!");
            document.getElementById('c-'+id).value='';
        }
    });
}

// ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… (Admin)
function toggleRec(id,status){ db.ref(`received_totals/${id}`).set(!status); }

// ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø±
function resetMonth(){ if(confirm("ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø¯ÙØ¹Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ")) db.ref(`payments/${monthKey}`).remove(); }

// Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
function adminLoginPrompt(){ document.getElementById('adminSection').style.display='block'; window.scrollTo(0,document.body.scrollHeight); }

// ØªØ°ÙƒÙŠØ± ÙŠÙˆÙ… 22 Ù„Ù…Ù† Ù„Ù… ÙŠØ³Ø¯Ø¯
function checkLatePayments(payments){
    const today=new Date().getDate();
    if(today>=22){
        let late=false;
        members.forEach(m=>{ if(!payments[m.id] || payments[m.id].status!==true) late=true; });
        if(late) setTimeout(()=>showAlert("âš ï¸ ØªØ°ÙƒÙŠØ±: Ø§Ù„ÙŠÙˆÙ… "+today+" ÙˆÙ‡Ù†Ø§Ùƒ Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ù… ÙŠØ³Ø¯Ø¯ÙˆØ§ Ø§Ù„Ù‚Ø³Ø· Ø¨Ø¹Ø¯."),2000);
    }
}
</script>
</body>
</html>
