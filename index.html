<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spaarkring - Dashboard</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

<style>
body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; text-align: center; direction: rtl; margin: 0; padding: 10px; }
.container { max-width: 500px; margin: 10px auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
h1 { color: #1a73e8; cursor: pointer; margin-bottom: 5px; }
.status-card { background: #e8f4fd; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-weight: bold; border-right: 5px solid #1a73e8; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { padding: 10px 5px; border-bottom: 1px solid #eee; font-size: 0.85em; }
.paid { color: #27ae60; font-weight: bold; }
.not-paid { color: #e74c3c; font-weight: bold; }
.btn-verify { background: #27ae60; color: white; border: none; padding: 4px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
.custom-alert { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
.alert-content { background-color: white; margin: 30% auto; padding: 25px; border-radius: 15px; width: 80%; max-width: 350px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
.alert-btn { background: #1a73e8; color: white; border: none; padding: 10px 30px; border-radius: 8px; cursor: pointer; margin-top: 20px; font-weight: bold; width: 100%; }
.code-input { width: 60px; text-align: center; padding: 5px; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }
input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
#adminPanel { display: none; margin-top: 30px; border-top: 2px dashed #dc3545; padding: 15px; background: #fffdfd; border-radius: 10px; }
.admin-input { width: 90%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; }
.btn-reset { background: #c0392b; color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; }
.payout-container { background:#f9fffb; padding:15px; border-radius:10px; margin-top:30px; border: 1px solid #d1fae5; }
.toggle-btn { background: #3182ce; color: white; border: none; padding: 3px 6px; border-radius: 3px; font-size: 0.7em; cursor: pointer; }
</style>
</head>
<body>

<div class="container">
<h1 onclick="toggleAdminView()">Spaarkring</h1>
<div class="status-card">ğŸ“¢ Ø§Ù„Ù‚Ø³Ø·: 400 ÙŠÙˆØ±Ùˆ | Ø§Ù„Ù…ÙˆØ¹Ø¯: 22 Ù…Ù† Ø§Ù„Ø´Ù‡Ø±</div>
<h3 id="monthLabel"></h3>

<table>
<thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ£ÙƒÙŠØ¯</th></tr></thead>
<tbody id="memberTable"></tbody>
</table>

<div class="payout-container">
<h3 style="color:#2d3748; margin-top:0;">ğŸ’° Ø³Ø¬Ù„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ø§Ù„Øº (4000â‚¬)</h3>
<table>
<thead><tr id="payoutHeader"><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th></tr></thead>
<tbody id="payoutTable"></tbody>
</table>
</div>

<div id="adminPanel">
<div id="loginForm">
<h4 style="color:#c0392b;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h4>
<input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" class="admin-input">
<input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="admin-input">
<button onclick="loginAdmin()" style="background:#2c3e50; color:white; width:95%; padding:10px; border:none; border-radius:5px;">Ø¯Ø®ÙˆÙ„</button>
</div>
<div id="adminControls" style="display:none;">
<p style="color:#27ae60; font-weight:bold;">Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙŠØ§ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</p>
<button onclick="resetMonthData()" class="btn-reset">âš ï¸ ØªØµÙÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯</button>
<button onclick="logoutAdmin()" style="background:#95a5a6; color:white; border:none; padding:8px; border-radius:5px; margin-top:20px; width:95%;">Ø®Ø±ÙˆØ¬</button>
</div>
</div>
</div>

<div id="myAlert" class="custom-alert">
<div class="alert-content">
<p id="alertMsg" style="color: #333; font-size: 1.1em; line-height: 1.5;"></p>
<button onclick="closeAlert()" class="alert-btn">Ù…ÙˆØ§ÙÙ‚</button>
</div>
</div>

<script>
/* Firebase config */
const firebaseConfig = {
    apiKey: "AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",
    authDomain: "jamia-app-5bd27.firebaseapp.com",
    databaseURL: "https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "jamia-app-5bd27",
    storageBucket: "jamia-app-5bd27.appspot.com",
    messagingSenderId: "870308712173",
    appId: "1:870308712173:web:be101df99fef412f7886e4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© */
const members = ["Ù…Ø­Ø³Ù†","Ø³Ù„ÙŠÙ…","Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯","Ù…Ø´ØªØ§Ù‚","Ø±Ø¶ÙˆØ§Ù†","Ø­Ù…Ø²Ø©","Ø¹Ù„ÙŠ","Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†","Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯","Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†"];
const monthKey = new Date().getFullYear() + "-" + (new Date().getMonth()+1).toString().padStart(2,'0');
document.getElementById('monthLabel').innerText = "Ø³Ø¬Ù„ Ø´Ù‡Ø±: "+new Date().toLocaleDateString('ar-EG',{month:'long', year:'numeric'});

/* Alert */
function showAlert(msg){ document.getElementById('alertMsg').innerHTML=msg; document.getElementById('myAlert').style.display='block'; }
function closeAlert(){ document.getElementById('myAlert').style.display='none'; }

/* Anonymous Auth Ù„Ù„Ø²ÙˆØ§Ø± */
auth.onAuthStateChanged(user=>{
    if(!user) auth.signInAnonymously();

    const admins = ["Mohammeddalmohsen@gmail.com"];
    const isAdmin = user && !user.isAnonymous && admins.includes(user.email);

    document.getElementById('loginForm').style.display = isAdmin?'none':'block';
    document.getElementById('adminControls').style.display = isAdmin?'block':'none';

    const header = document.getElementById('payoutHeader');
    header.innerHTML = `<th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>${isAdmin?'<th>ØªØ­ÙƒÙ…</th>':''}`;
    loadData();
});

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
function loadData(){
    db.ref().on('value', snap=>{
        const data = snap.val() || {};
        const payments = data.payments ? (data.payments[monthKey] || {}) : {};
        const received = data.received_totals || {};
        const user = auth.currentUser;
        const admins = ["Mohammeddalmohsen@gmail.com"];
        const isAdmin = user && !user.isAnonymous && admins.includes(user.email);

        let h='';
        members.forEach((name,i)=>{
            const id=i+1;
            const paid = payments[id] && payments[id].status;
            h+=`<tr><td><b>${name}</b></td><td class="${paid?'paid':'not-paid'}">${paid?'âœ…':'âŒ'}</td>
            <td>${paid?'âœ”ï¸':`<input type="number" id="in-${id}" class="code-input"> <button onclick="verify(${id},'${name}')" class="btn-verify">OK</button>`}</td></tr>`;
        });
        document.getElementById('memberTable').innerHTML=h;

        let ph='';
        members.forEach((name,i)=>{
            const id=i+1;
            const rec = received[id]===true;
            ph+=`<tr><td>${name}</td><td class="${rec?'paid':'not-paid'}">${rec?'ØªÙ… âœ…':'Ù„Ù… ÙŠØ³ØªÙ„Ù…'}</td>
            ${isAdmin?`<td><button onclick="toggleRec(${id},${rec})" class="toggle-btn">ØªØ¨Ø¯ÙŠÙ„</button></td>`:''}</tr>`;
        });
        document.getElementById('payoutTable').innerHTML=ph;
    });
}

/* ØªØ­Ù‚Ù‚ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø²Ø§Ø¦Ø± */
function verify(id,name){
    const codeInput = document.getElementById('in-'+id).value;
    if(!codeInput) return showAlert("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹");

    db.ref('secret_codes/'+id).once('value').then(snap=>{
        const correctCode = snap.val();
        if(String(codeInput) === String(correctCode)){
            db.ref(`payments/${monthKey}/${id}`).set({status:true, date: new Date().toLocaleDateString('ar-EG')});
            showAlert(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ ${name}`);
            sendPushNotification(`âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº Ù…Ù†: ${name}`);
        } else {
            showAlert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
    });
}

/* Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ */
function resetMonthData(){ 
    if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø´Ù‡Ø±ØŸ")){
        db.ref(`payments/${monthKey}`).remove();
        sendPushNotification("ğŸ“… ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø³Ø¬Ù„ Ù„Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯");
    }
}
function toggleRec(id,s){ db.ref(`received_totals/${id}`).set(!s); }
function toggleAdminView(){ const p=document.getElementById('adminPanel'); p.style.display=(p.style.display==='block')?'none':'block'; }
function loginAdmin(){ auth.signInWithEmailAndPassword(document.getElementById('email').value,document.getElementById('pass').value).catch(e=>showAlert(e.message)); }
function logoutAdmin(){ auth.signOut().then(()=>location.reload()); }

/* Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
function sendPushNotification(msg){
    fetch('/api/send-notification',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message: msg})
    });
}
</script>
</body>
</html>
