const firebaseConfig={apiKey:"AIzaSyC-J-Cg9OeZD--fwStoZTFzK4xFy5ylz9I",authDomain:"jamia-app-5bd27.firebaseapp.com",databaseURL:"https://jamia-app-5bd27-default-rtdb.europe-west1.firebasedatabase.app",projectId:"jamia-app-5bd27",storageBucket:"jamia-app-5bd27.appspot.com",messagingSenderId:"870308712173",appId:"1:870308712173:web:be101df99fef412f7886e4"};firebase.initializeApp(firebaseConfig);const db=firebase.database(),auth=firebase.auth(),members=["Ù…Ø­Ø³Ù†","Ø³Ù„ÙŠÙ…","Ø£Ø¨Ùˆ Ù…Ø­Ù…Ø¯","Ù…Ø´ØªØ§Ù‚","Ø±Ø¶ÙˆØ§Ù†","Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†","Ø¹Ù„ÙŠ","Ø£Ø¨Ùˆ Ù‡ØªØ§Ù†","Ø£Ø¨Ùˆ Ø®Ø§Ù„Ø¯","Ø­Ù…Ø²Ø©"],monthKey=new Date().getFullYear()+"-"+(new Date().getMonth()+1).toString().padStart(2,"0");document.getElementById("monthLabel").innerText="Ø³Ø¬Ù„ Ø´Ù‡Ø±: "+new Date().toLocaleDateString("ar-EG",{month:"long",year:"numeric"});function showAlert(a){document.getElementById("alertMsg").innerText=a,document.getElementById("myAlert").style.display="block"}function closeAlert(){document.getElementById("myAlert").style.display="none"}auth.onAuthStateChanged(a=>{document.getElementById("adminPanel").style.display="block",a||(auth.signInAnonymously(),loadData(!1));const b=!a.isAnonymous&&"mohammeddalmohsen@gmail.com"===a.email.toLowerCase();showAdmin(b),loadData(b)});function showAdmin(a){document.getElementById("loginForm").style.display="none",document.getElementById("adminControls").style.display=a?"block":"none"}function toggleAdminView(){const a=document.getElementById("loginForm");a.style.display="block"===a.style.display?"none":"block"}function loadData(a){db.ref().on("value",b=>{const c=b.val()||{},d=c.payments&&c.payments[monthKey]?c.payments[monthKey]:{},e=c.received_totals||{};let f="";members.forEach((b,c)=>{const g=c+1,h=d[g]&&d[g].status;f+=`<tr><td><b>${b}</b></td><td class="${h?"paid":"not-paid"}">${h?"âœ…":"âŒ"}</td><td>${h?"âœ”ï¸":`<input type="number" id="in-${g}" class="code-input" inputmode="numeric"> <button onclick="verify(${g},'${b}')" class="btn-verify">OK</button>`}</td></tr>`}),document.getElementById("memberTable").innerHTML=f;let h="";members.forEach((b,c)=>{const g=c+1,i=e[g]===!0;h+=`<tr><td>${b}</td><td class="${i?"paid":"not-paid"}">${i?b+" Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© âœ…":"Ù„Ù… ÙŠØ³ØªÙ„Ù…"}</td><td>${a?`<button onclick="toggleRec(${g},${i})" class="btn-verify">ØªØ¨Ø¯ÙŠÙ„</button>`:""}</td></tr>`}),document.getElementById("payoutTable").innerHTML=h})}function verify(a,b){const c=document.getElementById('in-'+a).value;if(!c)return showAlert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯");db.ref("secret_codes/"+a).once("value").then(d=>{String(c)===String(d.val())?(db.ref(`payments/${monthKey}/${a}`).set({status:!0,date:new Date().toLocaleDateString()}),showAlert(`âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù€ ${b}`),sendPushNotification(`${b} Ø¯ÙØ¹ Ù‚Ø³Ø·Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­ âœ…`)):showAlert("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­")})}async function sendPushNotification(a){try{await fetch("/api/send-notification",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:a})}),console.log("Notification sent:",a)}catch(a){console.error("Notification Error:",a)}}function resetMonthData(){confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø³Ø¬Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±ØŸ")&&db.ref("payments/"+monthKey).remove().then(()=>{showAlert("ğŸ“… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­"),sendPushNotification("ğŸ“… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø³Ø¬Ù„ Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­")})}function toggleRec(a,b){db.ref("received_totals/"+a).set(!b);const c=document.querySelector(`#payoutTable tr:nth-child(${a}) td:first-child`).innerText;b||sendPushNotification(`${c} Ø§Ø³ØªÙ„Ù… Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…`)}function loginAdmin(){const a=document.getElementById("email").value,b=document.getElementById("pass").value;auth.signInWithEmailAndPassword(a,b).catch(a=>showAlert("Ø®Ø·Ø£: "+a.message))}function logoutAdmin(){auth.signOut().then(()=>location.reload())}
